Author: Giuseppe Iuculano <giuseppe@iuculano.it>
Description: Only admin can upgrade wordpress. (CVE-2008-6767) (Closes: #531736)
--- a/wp-admin/upgrade.php
+++ b/wp-admin/upgrade.php
@@ -16,6 +16,8 @@ define( 'WP_INSTALLING', true );
 
 /** Load WordPress Bootstrap */
 require( '../wp-load.php' );
+if(!current_user_can('level_10'))
+	wp_safe_redirect('../wp-login.php?upgrade');
 
 nocache_headers();
 
--- a/wp-login.php
+++ b/wp-login.php
@@ -663,6 +663,8 @@ default:
 		$errors->add('registered', __('Registration complete. Please check your e-mail.'), 'message');
 	elseif	( $interim_login )
 		$errors->add('expired', __('Your session has expired. Please log-in again.'), 'message');
+	elseif  ( isset($_GET['upgrade']) )
+		$errors->add('upgrade', __('Upgrade is needed, please log in with an admin account.'), 'message');
 	elseif ( strpos( $redirect_to, 'about.php?updated' ) )
 		$errors->add('updated', __( '<strong>You have successfully updated WordPress!</strong> Please log back in to experience the awesomeness.' ), 'message' );
 
